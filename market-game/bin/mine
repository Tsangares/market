#!/usr/bin/env python
import sys
sys.path.insert(0,'../src')

import argparse
from pymongo import MongoClient
from getpass import getpass
from Market import Market
from Business import Business
import time
from numpy.random import normal
from db import getProfile
parser = argparse.ArgumentParser(description='Utility used to make a trasaction between you and another business.')
parser.add_argument('money', metavar='money', type=float, nargs=1, help="The name of a business you want to transact with.")
parser.add_argument('-r','--repeat', dest='repeat', action='store_true')
args=parser.parse_args()

print("Retreieving profile...")
me=getProfile()

def mine():
    maxTime=30
    minTime=1
    width=maxTime-minTime
    money=args.money[0]
    maxMoney=30
    scale=(1-money/maxMoney)
    if scale > 1: scale=1
    if scale < 0: scale=0
    duration=-1
    while duration<minTime or duration>maxTime:
        duration=normal(width*scale+minTime,scale)
        #duration=width*scale+minTime
    steps=3
    print("Duration %.02f sec"%duration)
    for i in range(steps):
        print("."*(i+1))
        time.sleep(duration/steps)
    if money>maxMoney:
        print("The most money you can spend on this is %s."%maxMoney)
        money=maxMoney
    print("Spend %s money."%money)
    me.spend(money)
    print("Added 1 to your profile.")
    me.quantity+=1
    me.save()

if args.repeat:
    while True:
        mine()
        print("Repeating!")
else:
    mine()
    me.display()
